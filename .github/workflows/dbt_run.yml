name: Executar dbt no BigQuery

on:
  push:
    branches:
      - main # Roda automaticamente quando vocÃª envia cÃ³digo para a main
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * * '# Cria um botÃ£o no GitHub para vocÃª rodar manualmente quando quiser

# âš ï¸ OBRIGATÃ“RIO PARA O WIF (SEM CHAVES JSON) FUNCIONAR!
permissions:
  contents: read
  id-token: write

jobs:
  run-dbt:
    name: Run dbt models
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ”‘ Autenticar no Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # Puxa aquele endereÃ§o gigante que vocÃª salvou no GitHub Secrets
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          # A conta de serviÃ§o que criamos para o robÃ´
          service_account: 'dbt-github-runner@prd-igor.iam.gserviceaccount.com'

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # VersÃ£o estÃ¡vel recomendada para o dbt

      - name: ğŸ“¦ Instalar dbt-bigquery
        run: |
          pip install dbt-bigquery
          dbt --version

      - name: âš™ï¸ Instalar dependÃªncias do dbt
        run: dbt deps
        # Ajuste o caminho do --profiles-dir se o seu profiles.yml estiver em outra pasta
        
      - name: ğŸš€ Executar Modelos (Run & Test)
        run: dbt build --profiles-dir . 
        # 'dbt build' Ã© o comando moderno que roda os modelos e testa tudo de uma vez
